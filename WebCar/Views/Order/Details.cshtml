@model WebCar.Models.ViewModels.OrderDetailViewModel

@{
    ViewBag.Title = "Chi Tiết Đơn Hàng #" + Model.MaDon;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-5 pt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Index", "Home")">
                            <i class="fas fa-home"></i> Trang chủ
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("MyOrders", "Order")">Đơn hàng của tôi</a>
                    </li>
                    <li class="breadcrumb-item active">Chi tiết #@Model.MaDon</li>
                </ol>
            </nav>

            <!-- Messages -->
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show">
                    <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show">
                    <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <!-- Order Header -->
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-file-invoice me-2"></i>
                        Đơn Hàng #@Model.MaDon
                    </h4>
                    <span class="badge bg-light text-dark fs-6">
                        @Model.NgayDat.ToString("dd/MM/yyyy HH:mm")
                    </span>
                </div>

                <div class="card-body p-4">
                    <div class="row">
                        <!-- Thông tin khách hàng -->
                        <div class="col-md-6 mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-user me-2"></i>Thông Tin Khách Hàng
                            </h5>
                            <div class="info-box p-3 border rounded bg-light">
                                <p class="mb-2">
                                    <strong><i class="fas fa-user-circle me-2"></i>Họ tên:</strong><br />
                                    @Model.HoTen
                                </p>
                                <p class="mb-2">
                                    <strong><i class="fas fa-envelope me-2"></i>Email:</strong><br />
                                    @Model.Email
                                </p>
                                <p class="mb-2">
                                    <strong><i class="fas fa-phone me-2"></i>Số điện thoại:</strong><br />
                                    @Model.SDT
                                </p>
                                <p class="mb-0">
                                    <strong><i class="fas fa-map-marker-alt me-2"></i>Địa chỉ:</strong><br />
                                    @Model.DiaChi
                                </p>
                            </div>
                        </div>

                        <!-- Trạng thái đơn hàng -->
                        <div class="col-md-6 mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-info-circle me-2"></i>Trạng Thái Đơn Hàng
                            </h5>
                            <div class="status-box p-3 border rounded bg-light">
                                <div class="mb-3">
                                    <span class="badge @(Model.TrangThai == "Cho xu ly" ? "bg-warning" :
                                                          Model.TrangThai == "Dang xu ly" ? "bg-info" :
                                                          Model.TrangThai == "Hoan thanh" ? "bg-success" : "bg-danger") fs-5">
                                        @(Model.TrangThai == "Cho xu ly" ? "Chờ xử lý" :
                                          Model.TrangThai == "Dang xu ly" ? "Đang xử lý" :
                                          Model.TrangThai == "Hoan thanh" ? "Hoàn thành" : "Đã hủy")
                                    </span>
                                </div>

                                <!-- Timeline -->
                                <div class="timeline">
                                    <div class="timeline-item @(Model.TrangThai != "Da huy" ? "active" : "")">
                                        <i class="fas fa-check-circle"></i>
                                        <span>Đơn hàng đã tạo</span>
                                    </div>
                                    <div class="timeline-item @(Model.TrangThai == "Dang xu ly" || Model.TrangThai == "Hoan thanh" ? "active" : "")">
                                        <i class="fas fa-cog"></i>
                                        <span>Đang xử lý</span>
                                    </div>
                                    <div class="timeline-item @(Model.TrangThai == "Hoan thanh" ?  "active" : "")">
                                        <i class="fas fa-check-double"></i>
                                        <span>Hoàn thành</span>
                                    </div>
                                </div>

                                <!-- Nút hủy đơn -->
                                @if (Model.TrangThai == "Cho xu ly")
                                {
                                    using (Html.BeginForm("Cancel", "Order", new { id = Model.MaDon }, FormMethod.Post,
                                        new { @class = "mt-3", onsubmit = "return confirm('Bạn có chắc muốn hủy đơn hàng này? ');" }))
                                    {
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-danger btn-sm w-100">
                                            <i class="fas fa-times-circle me-2"></i>
                                            Hủy Đơn Hàng
                                        </button>
                                    }
                                }
                            </div>
                        </div>
                    </div>

                    <hr class="my-4" />

                    <!-- Thông tin sản phẩm -->
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-car me-2"></i>Chi Tiết Sản Phẩm
                    </h5>

                    <div class="row product-detail">
                        <div class="col-md-5">
                            @if (!string.IsNullOrEmpty(Model.HinhAnh))
                            {
                                <!-- ✅ MỚI: Đảm bảo đường dẫn đúng -->
                                <img src="@Url.Content(string.IsNullOrEmpty(Model.HinhAnh) || Model.HinhAnh.StartsWith("~/")
    ? Model.HinhAnh
    : "~/images/" + Model.HinhAnh. Replace("images/", ""))"
                                     alt="@Model.TenXe"
                                     onerror="this.src='@Url.Content("~/images/no-image.jpg")'" />
                            }
                        </div>

                        <div class="col-md-7">
                            <h4 class="mb-3">@Model.TenXe</h4>
                            <p class="text-muted mb-3">
                                <i class="fas fa-building me-2"></i>
                                Hãng: <strong>@Model.HangXe</strong>
                            </p>

                            <div class="product-info mb-3">
                                <p class="mb-2">@Model.MoTa</p>
                            </div>

                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <td class="text-muted">Đơn giá:</td>
                                        <td class="text-end"><strong>@Model.DonGia.ToString("N0") VNĐ</strong></td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Số lượng:</td>
                                        <td class="text-end"><strong>@Model.SoLuong</strong></td>
                                    </tr>
                                    <tr class="table-primary">
                                        <td><h5 class="mb-0">Tổng tiền:</h5></td>
                                        <td class="text-end">
                                            <h4 class="text-danger mb-0">@Model.TongTien.ToString("N0") VNĐ</h4>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="mt-4 d-flex justify-content-between">
                        <a href="@Url.Action("MyOrders", "Order")" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            Quay Lại
                        </a>

                        <a href="@Url.Action("Index", "Product")" class="btn btn-primary">
                            <i class="fas fa-shopping-cart me-2"></i>
                            Tiếp Tục Mua Sắm
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .info-box, .status-box {
            background: #f8f9fa;
        }

        .timeline {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0.5;
        }

            .timeline-item.active {
                opacity: 1;
                font-weight: bold;
                color: #0066cc;
            }

            .timeline-item i {
                font-size: 1.2rem;
            }

        .product-detail img {
            max-height: 300px;
            width: 100%;
            object-fit: cover;
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            setTimeout(function() {
                $('. alert').fadeOut('slow');
            }, 5000);

            console.log('✅ Order Details page loaded');
        });
    </script>
}